# gost270875
ГОСТ 2708-75. Лесоматериалы круглые. Таблицы объемов. Скрипт для Гугл Таблиц.
Поддерживаемые длины (м): 2, 2.5, 2.7, 3, 4, 5, 5.4 и 6.
Поддерживаемые диаметры (см): [8, 56]

<br/>

# Документация

## Общая информация

В Microsoft Excel скрипты и макросы пишутся на языке Visual Basic (VBA scripts).
Макрос - записанная цепочка действий на одном рабочем листе, которую можно повторять на другом листе.
Инструменты -> Макросы -> Записать макрос (Настроить макрос, Импорт).
Скрипт - программный код ассоциированный с документом. Может вызываться через функции, удалённо и некоторыми другими способами.
Инструменты -> Редактор скриптов. 
В гугл-таблицах скрипты пишутся на языке JavaScript.

Необходимо написать функцию для расчёта кубатуры круглого леса. На входе - длина стволов, набор диаметров и количество брёвен определённого диаметра. Расчёт производится на основе ГОСТ 2708-75. На выходе - общая кубатура всех брёвен.

Официальная документация по функциям: https://developers.google.com/apps-script/guides/sheets/functions
1. You can use Google Apps Script to write custom functions
2. Custom functions are created using standard JavaScript.
3. Tools > Script editor
3.1. Write function
3.2. Select the menu item File > Save. Give the script project a name and click OK.
4. Call function from sheet (=FUNCNAME())

## Алгоритм

Функция: =КУБАТУРА("НазваниеСтолбца"; debug)
На входе - название столбца. Примеры: КУБАТУРА("N"), КУБАТУРА("O"), КУБАТУРА("PQ"). Если передан второй параметр - включается отладочный режим.
На выходе - либо суммарная кубатура, либо отладочная информация.

Общая логика:
1. Скрипт работает в рамках текущего листа
2. Формат числовой ячейки "#,##0.00". Этот формат выставляется по умолчанию через задание "Формат -> Числа -> Число".
3. Когда нужно текстовое значений ячейки используется функция cell.getDisplayValue()
4. Когда нужно числовое значение ячейки - в текстовом представлении запятые заменяются на точки и используется функция parseFloat(cell.getDisplayValue().replace(',', '.'))

Алгоритм:
1. Проверяем, что столбец А содержит в строках с 9 по 56 числа. Все ячейки должны быть заполнены. В противном случае генерируем ошибку.
2. Проверяем, что столбец НазваниеСтолбца содержит в строках с 9 по 56 числа. Некоторые ячейки могут быть пустыми. Если ячейка не пустая и её содержимое не является числом - генерируем ошибку.
3. Проверяем, что значение ячейки НазваниеСтолбца7 - число. Преобразуем его в строку. Запоминаем  в переменную Длина. В противном случае генерируем ошибку.
4. Проверяем, что для Длина есть полный набор Диаметров (столбец А) в таблице кубатур. Если нет - генерируем ошибку.
5. Переменная ОбщаяКубатура = 0
6. Цикл по числам от 9 до 56, переменная K
7. Взять диаметр из столбца А + K, переменная ДиаметрК
8. Получить из таблицы кубатур объём одного бревна длиной Длина и диаметром ДиаметрК. Переменная ОбъёмОдного.
9. Взять из столбца НазваниеСтолбца + K количество брёвен. Переменная КоличествоК.
10. Прибавить к ОбщаяКубатура произведение ОбъёмОдного на КоличествоК
11. Перейти к следующему элементу цикла
12. Вернуть посчитанное значение ОбщаяКубатура

## ГОСТ 2708-75

На основе: http://docs.cntd.ru/document/gost-2708-75
см. файл: GostTable.gs

## Техническая документация

Техническая документация. Зафиксированы только моменты, которые лично у меня вызывали вопросы. Приведённая информация носит характер пошаговых заметок в процессе написания функции.

1. Получение текущего рабочего документа
var ss = SpreadsheetApp.getActiveSpreadsheet();

2. Получение первого листа в документе
var sheet = ss.getSheets()[0];

3. Получение значения ячейки
var cell = sheet.getRange("A0");
return cell.getValue();

4. Приватная функция. Чтобы функция не была видна на рабочем листе её имя должно заканчиваться на знак подчёркивания.
https://stackoverflow.com/questions/29014087/apps-script-private-functions
https://stackoverflow.com/questions/7875128/google-apps-script-for-spreadsheets-how-to-hide-a-helper-function-in-script-man

5. Проверка, что ячейка цифровая
https://stackoverflow.com/questions/35252684/if-var-isnumber-for-script

6. Генерирование ошибки с пользовательским текстом
throw new Error("Ошибка!");
https://stackoverflow.com/questions/17180141/how-do-you-pass-back-a-custom-error-message-from-google-apps-scripts

7. Проверка формата ячейки на число. Функция getNumberFormat().
cell.getNumberFormat() == "#,##0.00"
По умолчанию "Формат -> Числа -> Число" использует формат "#,##0.0". Соответственно, считаем, что ячейка является числовой тогда и только тогда, когда её формат совпадает с указанным.
https://stackoverflow.com/questions/8616254/formatting-numbers-read-from-spreadsheet

8. Преобразование содержимого ячейки в число - функция parseFloat(cell.getDisplayValue().replace(',', '.'))

9. Преобразование содержимого ячейки в строку - функция cell.getDisplayValue()
parseFloat() вернёт число. Но при его использовании в строковом контексте - оно будет преобразовываться в строку функцией toString(). Это не удобно, поскольку нужно учитывать много нюансов: целые числа идут без разделителя, десятичные дроби - с точкой в качестве разделителя и другие.
Для использования в строковом контексте проще взять уже отрисованное значение из ячейки. С предварительной проверкой, что ячейка содержала число. То есть проводилась проверка на ожидаемый формат и то, что содержимое ячейки преобразуется parseFloat() в число.
https://stackoverflow.com/questions/8616254/formatting-numbers-read-from-spreadsheet

10. Параметры функции в скрипте разделяются запятыми. При вызове - точкой с запятой.

11. Скрипт не может изменять значение сторонних ячеек. setValue не работает.
https://stackoverflow.com/questions/15933019/custom-function-throws-a-you-do-not-have-the-permission-required-to-setvalue-e

12. Встроенная документация jsdoc поддерживает только простейший синтаксис. Не поддерживается: перевод строк, описание параметров, значения по умолчанию, опциональные параметры и т.д.
https://stackoverflow.com/questions/61711660/what-amount-of-jsdoc-is-supported-in-google-sheets-custom-functions

13. Онлайн сервис для сверки результатов: https://calcstroy.ru/strojmaterial/raschjot-kubatury-kruglogo-lesa
Он округляет до 3 знака после запятой, поэтому возможны отклонения, но их порядок - 10 в минус 3 степени, либо 10 в минус 4, то есть десятые и сотые доли процента.
